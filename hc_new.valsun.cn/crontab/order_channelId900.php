<?php
error_reporting(E_ALL);
ini_set('max_execution_time', 1800);
if(!defined('WEB_PATH')){
	define("WEB_PATH","/data/web/order.valsun.cn/");
	//define("WEB_PATH","E:/www/zhang/code/order.valsun.cn/");
}
require_once WEB_PATH."crontab/scripts.comm.php";
require_once WEB_PATH_CONF_SCRIPTS."script.ebay.config.php";
/*include_once "/data/scripts/ebay_order_cron_job/ebay_order_cron_config.php";
include_once "/data/scripts/ebay_order_cron_job/function_purchase.php";*/
$ids = "8344971,8526402,8809110,8842096,8849112,8862631,8905974,8968635,9027686,9046612,9118441,9162772,9180940,9241329,9253209,9255395,9308486,9337524,9376347,9378671,9393954,9393969,9395762,9411833,9423987,9425121,9437038,9440042,9457216,9457399,9461841,9465559,9466929,9472244,9474385,9474603,9476126,9477416,9478721,9488351,9488479,9489020,9489408,9489608,9498874,9499144,9505075,9505151,9505733,9510621,9518194,9518200,9518866,9518898,9519076,9520197,9522183,9528779,9532719,9535192,9537456,9537668,9549634,9549643,9550596,9552004,9560244,9566234,9566248,9576989,9592573,9593512,9596753,9602420,9607647,9610633,9610776,9611433,9612362,9612887,9615401,9618958,9622477,9622500,9622512,9623276,9623437,9624016,9626076,9626316,9626385,9626403,9627404,9628510,9628655,9628837,9630913,9632026,9638991,9640585,9640604,9640770,9641002,9641274,9641395,9641400,9641529,9641744,9641829,9641892,9641946,9642205,9642380,9642780,9643939,9644644,9647186,9648475,9648478,9649284,9649286,9649649,9649652,9649804,9649855,9649885,9649894,9649909,9650192,9650198,9650241,9650322,9650380,9650381,9650388,9650472,9650552,9650556,9650571,9650583,9650585,9650612,9650615,9650637,9650649,9650673,9650681,9650685,9650696,9650704,9650726,9650741,9650761,9650785,9650826,9650834,9650838,9650841,9650914,9650937,9650958,9650989,9650995,9651008,9651120,9651151,9651279,9651333,9651351,9651363,9651509,9651618,9651712,9652013,9652039,9652041,9652172,9652197,9652273,9652274,9652294,9652355,9652365,9652441,9652483,9652513,9652523,9652547,9652570,9652815,9652829,9652830,9652834,9652929,9653014,9653027,9653103,9653345,9653349,9653350,9653489,9653567,9653637,9653677,9653784,9653786,9653790,9653826,9653866,9653868,9653869,9653870,9653871,9653874,9653878,9653879,9653884,9653938,9653941,9653959,9654055,9654059,9654061,9654071,9654075,9654084,9654323,9654332,9654572,9654573,9654641,9654778,9654784,9654792,9654961,9654964,9655179,9655255,9655506,9655538,9655556,9655630,9655643,9655646,9655671,9655734,9655775,9655777,9655835,9655967,9656086,9656198,9656208,9656209,9656210,9656251,9656277,9656279,9656329,9656522,9656529,9656541,9656593,9656629,9656634,9656655,9656746,9656921,9656942,9656983,9657107,9657174,9657175,9657345,9657511,9657566,9657641,9657677,9657678,9657680,9657802,9657803,9657860,9657985,9657994,9658000,9658004,9658012,9658030,9658074,9658081,9658114,9658141,9658156,9658209,9658246,9658286,9658295,9658296,9658321,9658337,9658449,9658458,9658501,9658595,9658649,9658691,9658784,9658798,9658809,9658834,9658840,9658845,9658852,9658914,9659006,9659007,9659009,9659083,9659084,9659144,9659148,9659151,9659355,9659378,9659401,9659451,9659581,9659594,9659726,9659804,9660076,9660388,9660393,9660399,9660406,9660453,9660460,9660603,9660862,9660864,9660877,9660942,9660952,9661096,9661119,9661156,9661187,9661292,9661308,9661481,9661622,9661850,9661890,9662030,9662113,9662117,9662121,9662146,9662160,9662162,9662249,9662343,9662457,9662471,9662502,9662696,9662732,9662733,9662832,9662908,9662909,9662971,9663010,9663014,9663236,9663254,9663380,9663386,9663408,9663692,9663693,9663754,9663826,9663894,9663998,9664012,9664080,9664090,9664093,9664112,9664175,9664191,9664192,9664196,9664335,9664338,9664341,9664554,9664751,9664968,9665016,9665209,9665222,9665309,9665392,9665396,9665667,9665668,9665707,9666120,9666124,9666258,9666262,9666264,9666344,9666377,9666383,9666384,9666751,9666828,9666947,9667031,9667206,9667332,9667564,9667567,9667580,9667581,9667597,9667754,9667802,9667826,9667835,9667843,9667849,9667949,9668151,9668683,9668685,9668773,9668802,9668808,9669255,9669262,9669265,9669268,9669273,9669285,9669541,9669883,9669964,9669972,9670114,9670129,9670286,9670338,9670393,9670407,9670411,9670417,9670426,9670683,9671287,9671290,9671452,9671531,9671634,9671680,9671693,9671896,9671934,9671973,9671988,9672000,9672194,9672339,9672362,9672698,9672735,9672743,9672751,9672790,9672911,9672993,9673004,9673101,9673218,9673319,9673323,9673380,9673421,9673452,9673475,9673516,9673643,9673668,9673747,9673749,9673753,9673760,9673777,9673778,9674395,9674419,9674848,9674850,9674852,9674854,9674885,9674899,9674908,9674913,9674920,9675055,9675087,9675137,9675157,9675229,9675242,9675271,9675583,9675584,9675586,9675595,9696845,9696880,9697073,9697082,9697092,9697095,9697105,9697110,9697115,9697254,9697750,9698264,9698356,9698805,9698808,9698810,9698813,9699173,9699175,9699179,9699182,9699184,9699267,9699821,9699892,9699900,9699908,9699923,9699924,9699927,9699930,9699976,9700235,9700312,9700333,9700357,9700399,9700931,9700973,9701169,9701449,9701648,9704135";
$idsArr = explode(',',$ids);

$tNameUnShipped = 'om_shipped_order';


/*$tNameOrderIdList = OrderInfoModel :: getTNameOrderIdByTSA($tNameUnShipped, $start, $end,' 1=1',900);

$orderIdArr = array ();
foreach ($tNameOrderIdList as $value) {
	$orderIdArr[] = $value['id'];
}
$orderIdStr = implode(',', $orderIdArr);
if (empty ($orderIdStr)) {
	$orderIdStr = 0;
}*/

//$where = "WHERE id in($orderIdStr) AND channelId = '0' ";
//$where = "WHERE id in($idsStr)";
//$count = OmAvailableModel::getTNameCount($tNameUnShipped, $where);
//echo "totalcount = $count";
//echo "\n";
//exit;
//$start = 0;
//$per = 5000;
//$page = ceil($count/$per);
//
//echo "totalpage = $page";
//echo "\n";
//
//for($i=0;$i<$page;$i++){
//    echo "currentPage = $i";
//    echo "\n";
//    $start = $start*$i;
//    $where = "WHERE channelId=0 ORDER BY id desc ";
//    $where .= " limit $start,$per";
//print_r($idsArr);
//exit;
    foreach($idsArr as $ids1){
        $where = "WHERE id=$ids1";
        $shipOrderList = OrderindexModel :: showOrderList($tNameUnShipped, $where);
        foreach($shipOrderList as $key => $value){
        	$id			=	$value['orderData']['id'];
        	$weight		=	$value['orderWhInfoData']['actualWeight'];
        	$country	=	$value['orderUserInfoData']['countryName'];
        	$transportId =  $value['orderData']['transportId'];
        	$shaddr		=	1;
        	echo "id = $id";
        	echo "\n";
        	if(empty($weight) || empty($country) || empty($transportId)){
        		echo 'weight OR countryName or transportId is Empty!';
        		echo "\n";
        		continue;
        	}
        	$ifee		=	calcshippingfee($shaddr,$weight,$country,$transportId);
        	$channelId	=	'';
        	if(isset($ifee['channelId'])){
        		$channelId	=	$ifee['channelId'];
        	}
        	if(!empty($channelId) && !empty($id)){
        		error_log(time()."id: ".$id." channelId: ".$channelId." \r\n",3,'/data/web/order.valsun.cn/log/update_channelId.log');
        		updateChannelId($id,$channelId,$tNameUnShipped);
        	}else{
        		echo 'channelId OR id is Empty!';
        		echo "\n";
        		echo "channelId=$channelId,weight=$weight,country=$country,transportId=$transportId \n";
        	}
        }
    }
    
//}


function calcshippingfee($shaddr, $weight, $country, $transportId){
	require_once WEB_PATH."api/include/functions.php";

	$method = 'trans.carrier.fix.get';
	$paramArr= array(
		/* API系统级输入参数 Start */
		'method'	=> $method,  //API名称
		'format'	=> 'json',  //返回格式
		'v'			=> '1.0',   //API版本号
		'username'	=> C('OPEN_SYS_USER'),
		/* API系统级参数 End */
	);

	$paramArr['country'] = $country;
	$paramArr['weight'] = $weight;
	$paramArr['shaddr'] = $shaddr;
	$paramArr['carrier'] = $transportId;
	$result = callOpenSystem($paramArr);

	$data = json_decode($result,true);
	if(empty($data['data'])){
		return false;
	}
	return $data['data']['fee'];
}

function updateChannelId($id,$channelId,$tNameUnShipped) {
	global $dbConn;
	$sql	=	'UPDATE `'.$tNameUnShipped.'` SET channelId = "'.$channelId.'" WHERE id = "'.$id.'"';
	echo $sql; echo "\n";
	$sql	=	$dbConn->query($sql);
}


?>